---
import { Image } from 'astro:assets'
import { getCollection } from 'astro:content'
import { createMarkdown } from 'safe-marked'
import { createHighlighter } from 'shiki'
import BlogPost from '../../layouts/BlogPost.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blogs')

  return posts.map((post) => ({
    params: { blogId: post.id },
    props: post,
  }))
}

const post = Astro.props

const highlighter = await createHighlighter({
  themes: ['dark-plus'],
  langs: ['js', 'ts', 'tsx', 'json', 'css', 'astro', 'jsonc'],
})

const IMAGE_TOKEN = '__ASTRO_IMAGE__'

const markdown = createMarkdown({
  marked: {
    onInit(marked) {
      marked.use({
        renderer: {
          code(code, lang, _escaped) {
            return highlighter.codeToHtml(code, {
              lang: lang ?? 'text',
              theme: 'dark-plus',
            })
          },
          image(href, _title, text) {
            const payload = encodeURIComponent(
              JSON.stringify({
                href,
                text,
              }),
            )

            return `${IMAGE_TOKEN}${payload}${IMAGE_TOKEN}`
          },
        },
      })
    },
  },
})

const content = markdown(post.data.content)
const imageTokenRegex = /__ASTRO_IMAGE__([\s\S]*?)__ASTRO_IMAGE__/g
const contentParts: Array<
  | { type: 'html'; value: string }
  | { type: 'image'; href: string; alt?: string | null; imageIndex: number }
> = []

let lastIndex = 0
let imageIndex = 0

for (const match of content.matchAll(imageTokenRegex)) {
  const index = match.index ?? 0
  const payload = match[1] ?? ''
  const htmlChunk = content.slice(lastIndex, index)

  if (htmlChunk) {
    contentParts.push({ type: 'html', value: htmlChunk })
  }

  try {
    const data = JSON.parse(decodeURIComponent(payload)) as {
      href?: string
      text?: string | null
    }

    if (data && typeof data.href === 'string' && data.href) {
      contentParts.push({
        type: 'image',
        href: data.href,
        alt: data.text,
        imageIndex
      })

      imageIndex++
    }
  } catch {
    if (payload) {
      contentParts.push({
        type: 'html',
        value: `${IMAGE_TOKEN}${payload}${IMAGE_TOKEN}`,
      })
    }
  }

  lastIndex = index + match[0].length
}

const tail = content.slice(lastIndex)
if (tail) {
  contentParts.push({ type: 'html', value: tail })
}
---

<BlogPost post={post}>
  <section class="content mt-6">
    {contentParts.map((part, index) =>
      part.type === 'image' ? (
        <Image
          alt={part.alt ?? ''}
          decoding="async"
          inferSize
          priority={part.imageIndex === 0}
          loading={part.imageIndex < 3 ? 'eager' : 'lazy'}
          src={part.href}
        />
      ) : (
        <Fragment set:html={part.value} />
      ),
    )}
  </section>
</BlogPost>
